<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lucky Horses ‚Äî 3D Dice Edition</title>
<meta name="theme-color" content="#1e3a8a"/>
<link rel="icon" href="/logo.svg" type="image/svg+xml"/>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --pf-blue:#1e3a8a; --pf-red:#dc2626; --pf-green:#16a34a; --pf-gold:#f59e0b;
    --panel-bg:#f8fafc; --panel-border:#cbd5e1;
  }
  html,body{height:100%; background:#fff; color:#111; font-family:ui-sans-serif,system-ui,-apple-system,sans-serif}

  /* Layout: board left, player panel right */
  .wrap{display:grid; grid-template-columns:minmax(0,1fr) 380px; gap:16px; padding:14px; max-width:2000px; margin:0 auto}
  .board{
    position:relative; width:100%; aspect-ratio:16/9; border:6px solid var(--pf-blue);
    border-radius:24px; overflow:hidden; box-shadow:0 12px 0 rgba(30,58,138,.12);
    background:#eaf2ff url("LuckyHorses_Track.jpg") center/cover no-repeat;
  }

  /* Top banner for outcomes */
  .banner{
    position:absolute; left:50%; top:14px; transform:translateX(-50%);
    background:var(--pf-blue); color:#fff; padding:12px 22px; border-radius:16px;
    font-weight:900; font-size:clamp(20px,2.2vw,38px); text-shadow:0 2px 0 #0001;
    box-shadow:0 8px 16px rgba(0,0,0,.12);
  }

  /* Horses (big, right-facing) */
  .horse{
    position:absolute; transform:translate(-50%,-50%) scaleX(-1);
    font-size:clamp(38px,4.2vw,70px); line-height:1; filter:drop-shadow(0 2px 0 rgba(0,0,0,.2));
    transition:left .18s linear, top .18s linear;
  }
  .gallop{ animation:gallop .2s ease-in-out infinite alternate }
  @keyframes gallop{from{transform:translate(-50%,-50%) scaleX(-1) translateY(0)}to{transform:translate(-50%,-50%) scaleX(-1) translateY(-6px)}}

  /* Dice bottom-left (3D cube) */
  .dice-zone{ position:absolute; left:18px; bottom:18px; width:min(22vw,260px); height:min(22vw,260px); display:flex; align-items:flex-end; pointer-events:none}
  .dice-area{ perspective:1200px; margin-left:6px; margin-bottom:6px; pointer-events:auto}
  .cube{ position:relative; width:min(20vw,220px); height:min(20vw,220px); transform-style:preserve-3d; transform:rotateX(-15deg) rotateY(25deg); transition:transform 1s ease}
  .face{
    position:absolute; width:100%; height:100%; background:#fff; border:6px solid var(--pf-blue); border-radius:22px;
    box-shadow:0 12px 0 rgba(30,58,138,.12); display:flex; align-items:center; justify-content:center;
    font-size:clamp(26px,3vw,40px); font-weight:900; color:var(--pf-blue);
  }
  .cube{ --z: calc(min(20vw,220px)/2) }
  .face--front{ transform:translateZ(var(--z)) }
  .face--back{ transform:rotateY(180deg) translateZ(var(--z)) }
  .face--right{ transform:rotateY(90deg) translateZ(var(--z)) }
  .face--left{ transform:rotateY(-90deg) translateZ(var(--z)) }
  .face--top{ transform:rotateX(90deg) translateZ(var(--z)) }
  .face--bottom{ transform:rotateX(-90deg) translateZ(var(--z)) }
  .rolling{ animation:rollspin .9s cubic-bezier(.2,.8,.2,1) 1 }
  @keyframes rollspin{
    0%{transform:rotateX(0) rotateY(0)}
    40%{transform:rotateX(360deg) rotateY(360deg)}
    100%{transform:rotateX(720deg) rotateY(720deg)}
  }

  /* Right player panel */
  .panel{
    background:var(--panel-bg); border:3px solid var(--panel-border); border-radius:16px; padding:14px 14px 18px;
    display:flex; flex-direction:column; gap:12px; height:calc(100% - 0px)
  }
  .title{font-size:1.8rem; font-weight:900; color:var(--pf-blue)}
  .row{
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border:2px solid var(--panel-border);
    border-radius:14px; background:#fff; box-shadow:0 6px 0 rgba(15,23,42,.05)
  }
  .pill{border-radius:999px; color:#fff; padding:6px 12px; font-weight:900}
  .p-red{background:var(--pf-red)} .p-blue{background:var(--pf-blue)} .p-green{background:var(--pf-green)} .p-gold{background:var(--pf-gold)}
  .turn{ outline:4px solid #22d3ee; box-shadow:0 0 0 6px #22d3ee22 inset, 0 0 0 0 rgba(0,0,0,0); animation:glow 1.2s ease-in-out infinite alternate }
  @keyframes glow{from{outline-color:#22d3ee}to{outline-color:#38bdf8}}
  .score{font-weight:900; color:#0f172a}
  .btn{display:inline-block; text-align:center; font-weight:900; border-radius:12px; padding:14px 18px; font-size:1.2rem}
  .btn-blue{background:var(--pf-blue); color:#fff} .btn-red{background:#dc2626;color:#fff}

  .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
  .small{ font-size:0.95rem; color:#475569 }

  /* Footer legend */
  .legend{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:8px; color:#334155 }
  .chip{ border:2px solid #cbd5e1; border-radius:999px; padding:6px 12px; font-weight:800 }
</style>
</head>
<body>

<div class="wrap">
  <!-- BOARD -->
  <section class="board" id="board">
    <div class="banner" id="banner">Your turn: <b style="color:#dc2626">Ruby</b> ‚Äî click the die</div>

    <!-- Horses (absolute over background) -->
    <div id="h1" class="horse" style="color:var(--pf-red)">üêé</div>
    <div id="h2" class="horse" style="color:var(--pf-green)">üêé</div>
    <div id="h3" class="horse" style="color:var(--pf-gold)">üêé</div>
    <div id="h4" class="horse" style="color:var(--pf-blue)">üêé</div>

    <!-- Dice bottom-left -->
    <div class="dice-zone">
      <div class="dice-area">
        <div id="cube" class="cube" role="button" aria-label="Roll the die" tabindex="0">
          <!-- emoji-only faces -->
          <div class="face face--front">üêé</div>   <!-- +2 -->
          <div class="face face--back">üí§</div>    <!-- lose turn -->
          <div class="face face--right">üí®</div>   <!-- +3 -->
          <div class="face face--left">üíä</div>    <!-- -1 -->
          <div class="face face--top">üçÄ</div>     <!-- roll again -->
          <div class="face face--bottom">üêæ</div>  <!-- +1 -->
        </div>
      </div>
    </div>
  </section>

  <!-- PLAYER PANEL -->
  <aside class="panel" id="panel">
    <div class="title">Players</div>

    <div id="row1" class="row turn">
      <div><span class="pill p-red">Ruby</span></div>
      <div class="score">Lap: <span id="lap1">0</span></div>
    </div>
    <div id="row2" class="row">
      <div><span class="pill p-green">Clover</span></div>
      <div class="score">Lap: <span id="lap2">0</span></div>
    </div>
    <div id="row3" class="row">
      <div><span class="pill p-gold">Sunny</span></div>
      <div class="score">Lap: <span id="lap3">0</span></div>
    </div>
    <div id="row4" class="row">
      <div><span class="pill p-blue">Bluebell</span></div>
      <div class="score">Lap: <span id="lap4">0</span></div>
    </div>

    <div class="controls">
      <button id="rollBtn" class="btn btn-blue">üé≤ Roll</button>
      <button id="resetBtn" class="btn btn-red">üîÅ Reset</button>
      <button id="fsBtn" class="btn btn-blue">‚õ∂ Fullscreen</button>
    </div>
    <div class="small">Space = Roll ‚Ä¢ R = Reset ‚Ä¢ F = Fullscreen</div>

    <div class="legend">
      <span class="chip">üêæ +1</span>
      <span class="chip">üêé +2</span>
      <span class="chip">üí® +3</span>
      <span class="chip">üíä ‚àí1</span>
      <span class="chip">üí§ Lose turn</span>
      <span class="chip">üçÄ Roll again</span>
    </div>
  </aside>
</div>

<script>
  // ===== CONFIG =====
  const NAMES = ["Ruby","Clover","Sunny","Bluebell"];
  const COLORS = ["var(--pf-red)","var(--pf-green)","var(--pf-gold)","var(--pf-blue)"];

  // ellipse aligned to your background image (tuned for 16:9):
  // center roughly in the board, radii chosen to sit on your dirt track band.
  const TRACK = { cx: 0.5, cy: 0.50, rx: 0.41, ry: 0.28 }; // relative (of board w/h)
  const START_OFFSET = -Math.PI/10; // start near top-right straight; tweak if needed

  const STEPS_PER_LAP = 120;           // smoothness
  const SPACE = 10;                    // how many steps equal ‚Äúone space‚Äù of movement
  const MOVE_SPEED_MS = 140;           // per small step
  const LAPS_TO_WIN = 1;               // set to 2 for longer games

  // Dice faces: emoji-only visual + effect
  const FACES = [
    { emoji:"üêæ", effect:{type:"move", steps:+1}, rot:[-20,  20] }, // bottom up
    { emoji:"üêé", effect:{type:"move", steps:+2}, rot:[  0,   0] }, // front up
    { emoji:"üí®", effect:{type:"move", steps:+3}, rot:[  0,  90] }, // right up
    { emoji:"üíä", effect:{type:"move", steps:-1}, rot:[  0, -90] }, // left up
    { emoji:"üí§", effect:{type:"skip"},           rot:[180,   0] }, // back up
    { emoji:"üçÄ", effect:{type:"again"},          rot:[ 90,   0] }, // top up
  ];

  // ===== STATE =====
  let current = 0;                              // 0..3
  let pos = [0,0,0,0];                          // step positions 0..(STEPS_PER_LAP-1)
  let laps = [0,0,0,0];                         // completed laps
  let skipNext = [false,false,false,false];
  let finished = false;
  let rolling = false;

  // DOM
  const board = document.getElementById("board");
  const banner = document.getElementById("banner");
  const horses = [1,2,3,4].map(i => document.getElementById("h"+i));
  const cube = document.getElementById("cube");
  const rollBtn = document.getElementById("rollBtn");
  const resetBtn = document.getElementById("resetBtn");
  const fsBtn = document.getElementById("fsBtn");
  const lapEls = [1,2,3,4].map(i => document.getElementById("lap"+i));
  const rows = [1,2,3,4].map(i => document.getElementById("row"+i));

  // ===== HELPERS =====
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function cryptoInt(min,max){
    if (window.crypto?.getRandomValues){
      const range=max-min+1;
      const u=new Uint32Array(1); crypto.getRandomValues(u);
      return min + (u[0] % range);
    }
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  function setBanner(text){
    if (finished) return;
    banner.textContent = text;
  }
  function setTurnBanner(){
    setBanner(`Your turn: ${NAMES[current]}`);
  }
  function highlightTurn(){
    rows.forEach((r,i)=> r.classList.toggle("turn", i===current));
  }

  function boardDims(){
    const rect = board.getBoundingClientRect();
    return {w:rect.width, h:rect.height};
  }

  // convert step index to coordinates along an ellipse lane
  function stepToXY(step){
    const {w,h} = boardDims();
    const cx = TRACK.cx * w, cy = TRACK.cy * h;
    const rx = TRACK.rx * w, ry = TRACK.ry * h;
    const theta = START_OFFSET + (2*Math.PI) * (step / STEPS_PER_LAP);
    return { x: cx + rx*Math.cos(theta), y: cy + ry*Math.sin(theta) };
  }

  function placeHorse(i){
    const {x,y} = stepToXY(pos[i]);
    const el = horses[i];
    el.style.left = x + "px";
    el.style.top  = y + "px";
    el.style.color = COLORS[i];
  }

  function placeAll(){ for(let i=0;i<4;i++) placeHorse(i); }

  async function moveSteps(i, stepCount){
    const dir = Math.sign(stepCount);
    const total = Math.abs(stepCount);
    horses[i].classList.add("gallop");
    for(let s=0;s<total;s++){
      pos[i] = (pos[i] + dir + STEPS_PER_LAP) % STEPS_PER_LAP;
      placeHorse(i);
      await sleep(MOVE_SPEED_MS);
    }
    horses[i].classList.remove("gallop");
  }

  function addLapProgress(i, forwardSteps){
    // forwardSteps here equals SPACE * spacesMoved when effect is positive
    if (forwardSteps<=0) return false;
    const prev = Math.floor((pos[i]-forwardSteps+STEPS_PER_LAP)/STEPS_PER_LAP);
    const now  = Math.floor(pos[i]/STEPS_PER_LAP);
    // simpler approach: accumulate forward steps
    laps[i] += forwardSteps;
    if (laps[i] >= STEPS_PER_LAP * LAPS_TO_WIN){
      return true;
    }
    return false;
  }

  function updateLapUI(){
    for(let i=0;i<4;i++){
      lapEls[i].textContent = Math.floor(laps[i]/STEPS_PER_LAP);
    }
  }

  function announceWinner(i){
    finished = true;
    banner.textContent = `üèÜ Winner: ${NAMES[i]}!`;
    confetti();
  }

  function confetti(){
    const emojis = ["üéâ","üéä","üèÜ","üêé"];
    let n=0;
    const t=setInterval(()=>{
      const e=document.createElement("div");
      e.textContent=emojis[cryptoInt(0,emojis.length-1)];
      e.style.position="fixed"; e.style.left=Math.random()*100+"vw"; e.style.top="-10px";
      e.style.fontSize="2.2rem"; e.style.pointerEvents="none"; e.style.animation="fall 2s linear forwards";
      document.body.appendChild(e);
      setTimeout(()=>e.remove(),2050);
      if(++n>48) clearInterval(t);
    },60);
    const style=document.createElement("style");
    style.textContent="@keyframes fall{to{transform:translateY(100vh) rotate(360deg);opacity:.2}}";
    document.head.appendChild(style);
  }

  // ===== DICE =====
  async function roll(){
    if (finished || rolling) return;

    if (skipNext[current]){
      skipNext[current]=false;
      setBanner(`‚è≥ ${NAMES[current]} loses this turn`);
      await sleep(900);
      nextPlayer();
      return;
    }

    rolling = true;

    // spin
    cube.classList.remove("rolling");
    void cube.offsetWidth; // reflow
    cube.classList.add("rolling");

    // choose face
    const idx = cryptoInt(0, FACES.length-1);
    const face = FACES[idx];

    await sleep(900);
    cube.classList.remove("rolling");
    const [rx,ry] = face.rot;
    cube.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;

    await sleep(200);
    await applyEffect(face.effect);
    rolling = false;
  }

  async function applyEffect(effect){
    const me = current;

    if (effect.type === "move"){
      const spaces = effect.steps;
      if (spaces>0) setBanner(`${NAMES[me]} moves +${spaces}`);
      if (spaces<0) setBanner(`${NAMES[me]} goes ${spaces}`);
      const pixels = Math.abs(spaces) * SPACE; // convert spaces to ellipse steps
      const dir = Math.sign(spaces);
      await moveSteps(me, dir*pixels);
      const won = addLapProgress(me, dir>0 ? pixels : 0);
      updateLapUI();
      if (won){ announceWinner(me); return; }
      nextPlayer();
      return;
    }

    if (effect.type === "skip"){
      setBanner(`‚è≥ ${NAMES[me]} will lose next turn`);
      skipNext[me] = true;
      await sleep(800);
      nextPlayer();
      return;
    }

    if (effect.type === "again"){
      setBanner(`üçÄ ${NAMES[me]} rolls again`);
      await sleep(600);
      // same player keeps turn ‚Äî do nothing
      return;
    }
  }

  function nextPlayer(){
    current = (current+1) % 4;
    highlightTurn();
    setTurnBanner();
  }

  function resetGame(){
    finished=false; rolling=false;
    current=0; pos=[0,0,0,0]; laps=[0,0,0,0]; skipNext=[false,false,false,false];
    cube.style.transform = "rotateX(-15deg) rotateY(25deg)";
    placeAll(); updateLapUI(); highlightTurn();
    banner.innerHTML = `Your turn: <b style="color:#dc2626">Ruby</b> ‚Äî click the die`;
  }

  // ===== WIRE =====
  rollBtn.addEventListener("click", roll);
  cube.addEventListener("click", roll);
  cube.addEventListener("keydown", e=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); roll(); }});
  resetBtn.addEventListener("click", resetGame);
  fsBtn.addEventListener("click", ()=>{
    const el=document.documentElement;
    if(!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  });
  window.addEventListener("resize", placeAll);
  window.addEventListener("load", ()=>{ placeAll(); highlightTurn(); setTurnBanner(); });

  // Keyboard helpers
  document.addEventListener("keydown", (e)=>{
    if(e.key===" "){ e.preventDefault(); roll(); }
    if(e.key.toLowerCase()==="r") resetGame();
    if(e.key.toLowerCase()==="f") fsBtn.click();
  });
</script>
</body>
</html>
