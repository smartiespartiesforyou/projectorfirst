<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pop the Balloon ‚Äî Word Guess | ProjectorFirst</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .pf-blue-bg { background: #1e3a8a; } /* Your deep blue */
    .pf-blue-bg:hover { background: #1d4ed8; } /* Lighter blue on hover */
    .pf-blue-text { color: #1e3a8a; }

    /* Custom style for the large word blocks */
    .word-box-base {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100px;
        width: 80px;
        border-radius: 1rem; /* Consistent sharp corners */
        border: 4px solid;
    }

    /* Style for the current/hidden letters */
    .word-box-hidden {
        border-color: #1e3a8a; /* Dark blue border */
        background-color: #f3f4f6; /* Light gray background for contrast */
        color: #1e3a8a;
    }

    /* Style for the revealed letters */
    .word-box-revealed {
        border-color: #10b981; /* Green border */
        background-color: #fff;
        color: #1e3a8a;
        font-size: 3.75rem; /* text-6xl for big projection */
        font-weight: 900; /* font-extrabold */
    }

    /* Style for the used letters display */
    .used-letter {
        padding: 0 0.5rem;
        color: #1e3a8a;
    }
  </style>

  <script data-memberstack-app="app_cmgnwpg8y00x10suih4pua785"
          src="https://static.memberstack.com/scripts/v2/memberstack.js"
          type="text/javascript"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Safest wait for Memberstack to ensure it's loaded
      const waitForMemberstack = () =>
        new Promise((resolve) => {
          const check = () => {
            if (window.$memberstackDom) resolve(window.$memberstackDom);
            else setTimeout(check, 100);
          };
          check();
        });

      const memberstack = await waitForMemberstack();

      try {
        const { data: member } = await memberstack.getCurrentMember();
        // Redirect if not logged in
        if (!member) {
          window.location.replace("index.html");
          return;
        }

        // Check for active plan (or trial plan if applicable)
        const hasAccess = Array.isArray(member.planConnections) &&
          member.planConnections.some(plan => plan.status === "ACTIVE" || plan.planId === "pln_trial30-gpte0tfl");

        if (!hasAccess) {
          window.location.replace("checkout.html");
          return;
        }
      } catch (e) {
        console.error("Auth check failed:", e);
        window.location.replace("index.html");
      }
    });
  </script>
</head>

<body class="bg-white text-gray-900 min-h-screen">
  
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-800 text-center mb-6">Pop the Balloon</h1>

    <div class="flex justify-center mb-8">
      <a href="apps.html"
           class="pf-blue-bg inline-flex items-center gap-2 px-6 py-3 text-white rounded-xl font-extrabold text-xl shadow-lg hover:pf-blue-bg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-150">
        ‚Üê Back to Apps
      </a>
    </div>

    <div class="grid md:grid-cols-3 gap-6 md:gap-8 items-end mb-10 p-4 border-b-2 border-gray-200">
      <div>
        <label for="theme" class="block text-lg font-semibold pf-blue-text mb-2">Choose a Theme</label>
        <select id="theme"
                class="w-full text-xl p-4 border-4 border-blue-900 rounded-xl bg-gray-50 appearance-none focus:outline-none focus:ring-4 focus:ring-blue-300">
          <option value="animals">Animals</option>
          <option value="countries">Countries</option>
          <option value="foods">Foods</option>
        </select>
      </div>

      <div>
        <label class="block text-lg font-semibold pf-blue-text mb-2">Start a New Round</label>
        <button id="newBtn"
                class="w-full pf-blue-bg hover:pf-blue-bg text-white text-xl py-4 px-6 rounded-xl font-extrabold transition duration-150 shadow-md">
          New Word
        </button>
      </div>

      <div class="md:text-right text-gray-700 text-lg font-medium py-2">
        **Guess letters** by shouting them out, or pressing keys. Wrong guesses pop balloons! üéà
      </div>
    </div>

    <div id="balloons"
         class="flex items-center justify-center gap-4 mb-16 h-20"
         aria-label="Remaining balloons"></div>

    <div id="word"
         class="flex flex-wrap items-center justify-center gap-3 md:gap-5 mb-16 min-h-28"
         aria-label="Hidden word"></div>

    <div id="status"
         class="text-center text-3xl font-bold pf-blue-text mb-16 h-10"
         aria-live="polite"></div>

    <div class="text-center text-xl font-bold text-gray-700 mb-4">Used Letters</div>
    <div id="usedLetters"
         class="flex flex-wrap justify-center gap-x-6 gap-y-3 text-5xl font-extrabold border-t-2 border-gray-200 pt-6">
    </div>
  </div>

  <script>
    // WORD BANKS (Kept unchanged)
    const BANK = {
      animals: ["ELEPHANT","KANGAROO","ALLIGATOR","PORCUPINE","CHAMELEON","ARMADILLO","RHINOCEROS","HIPPOPOTAMUS","FLAMINGO","WOLVERINE"],
      countries: ["ARGENTINA","VENEZUELA","AUSTRALIA","NETHERLANDS","PHILIPPINES","SWITZERLAND","ZIMBABWE","KAZAKHSTAN","SINGAPORE","GUATEMALA"],
      foods: ["SPAGHETTI","PINEAPPLE","CHOCOLATE","CROISSANT","BLUEBERRY","WATERMELON","LASAGNA","CANNELLONI","MARSHMALLOW","ARTICHOKE"],
    };

    const MAX_MISSES = 6;
    let theme = "animals";
    let word = "";
    let revealed = [];
    let used = new Set();
    let misses = 0;
    let finished = false;

    function pickWord() {
      const list = BANK[theme];
      return list[Math.floor(Math.random() * list.length)].toUpperCase();
    }

    function resetRound() {
      word = pickWord();
      revealed = Array.from(word, ch => (ch === " " || ch === "-" ? true : false));
      used.clear();
      misses = 0;
      finished = false;
      renderAll();
      setStatus("Guess a letter to begin!");
    }

    function setStatus(msg, color = "pf-blue-text") {
      const el = document.getElementById("status");
      el.className = `text-center text-3xl font-bold ${color} mb-16 h-10`;
      el.textContent = msg;
    }

    function renderBalloons() {
      const wrap = document.getElementById("balloons");
      wrap.innerHTML = "";
      const remaining = MAX_MISSES - misses;
      for (let i = 0; i < remaining; i++) {
        wrap.innerHTML += `<span class="text-7xl transition-opacity duration-300">üéà</span>`;
      }
      for (let i = 0; i < misses; i++) {
        wrap.innerHTML += `<span class="text-7xl transition-opacity duration-300">üí•</span>`;
      }
    }

    function renderWord() {
      const wrap = document.getElementById("word");
      wrap.innerHTML = "";
      Array.from(word).forEach((ch, i) => {
        const box = document.createElement("div");
        if (ch === " ") {
          box.className = "w-10 h-20"; // Space separator
          box.textContent = "";
        } else if (ch === "-") {
          box.className = "text-5xl font-bold text-gray-700 pt-4"; // Hyphen
          box.textContent = "-";
        } else {
          const shown = revealed[i];
          box.className = "word-box-base transition duration-150 " +
                            (shown ? "word-box-revealed" : "word-box-hidden");
          
          const textSpan = document.createElement("span");
          // Increase size of the hidden placeholder for projection
          textSpan.className = `leading-none ${shown ? "" : "text-5xl"}`; 
          textSpan.textContent = shown ? ch : "_";
          
          box.appendChild(textSpan);
        }
        wrap.appendChild(box);
      });
    }

    function renderUsedLetters() {
      const wrap = document.getElementById("usedLetters");
      wrap.innerHTML = "";
      // Sort letters for clean display
      [...used].sort().forEach(letter => { 
        // Use a less pronounced color for used letters
        const isCorrect = word.includes(letter);
        const colorClass = isCorrect ? 'text-green-600' : 'text-red-600';
        wrap.innerHTML += `<span class="used-letter ${colorClass}">${letter}</span>`;
      });
    }

    function handleGuess(letter) {
      if (finished || used.has(letter)) return;
      
      let correct = false;
      const originalMisses = misses;

      if (word.includes(letter)) {
        for (let i = 0; i < word.length; i++) {
          if (word[i] === letter) {
            revealed[i] = true;
            correct = true;
          }
        }
      } else {
        misses++;
      }
      used.add(letter);

      if (correct) {
        setStatus(`‚úÖ Nice! The letter ${letter} is in the word.`, "text-green-700");
      } else {
        setStatus(`üí• Not there. Balloon popped! (${MAX_MISSES - misses} left)`, "text-red-700");
      }

      if (revealed.every((v) => v)) {
        finished = true;
        setStatus("üéâ You saved the balloons! Word solved!", "text-green-700");
      } else if (misses >= MAX_MISSES) {
        finished = true;
        setStatus(`üí• All balloons popped! The word was ${word}.`, "text-red-700");
      }

      renderAll();
    }

    function renderAll() {
      renderBalloons();
      renderWord();
      renderUsedLetters();
    }

    // Hook up
    document.getElementById("theme").addEventListener("change", e => {
      theme = e.target.value;
      resetRound();
    });
    document.getElementById("newBtn").addEventListener("click", resetRound);

    // Start
    resetRound();

    // Key listener for group play (Kept unchanged)
    document.addEventListener("keydown", e => {
      const letter = e.key.toUpperCase();
      if (letter.length === 1 && letter >= "A" && letter <= "Z") {
        handleGuess(letter);
      }
    });
  </script>
</body>
</html>
