<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Activity Calendar Maker — Designer Mode</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF & Canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { background:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

    @media print {
      @page { size: 11in 17in landscape; margin: 0.5in; }
      #toolbar, #graphics-panel, #contextMenu { display: none !important; }
      body { margin: 0; }
    }

    /* Printable area */
    #print-area {
      position: relative;
      background:#fff;
      box-shadow: 0 0 0 1px #cbd5e1;
      overflow: hidden;
    }

    /* Background */
    #bgTheme {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      pointer-events:none;
      z-index:0;
    }

    .weekday {
      background:#1e3a8a;
      color:#fff;
      font-weight:700;
      text-align:center;
      padding:0.5rem;
    }

    .day-grid { position:relative; z-index:1; }

    .day-box {
      position: relative;
      min-height: 9rem;
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
      padding: 0.25rem;
      overflow: hidden;
      background-clip: padding-box;
    }

    .inactive { opacity:0.25; }
    .inactive .day-content:empty::before { content: ""; }

    .day-num {
      position: absolute;
      top: 0.35rem;
      right: 0.45rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: #374151;
    }

    .day-content {
      margin-top: 1rem;
      padding: 0.25rem;
      line-height: 1.25rem;
      font-size: 0.95rem;
      outline: none;
      min-height: 7rem;
      white-space: pre-wrap;
    }

    .day-content:empty::before {
      content: "Type here…";
      color: #9ca3af;
      white-space: pre-wrap;
    }

    .draggable-img { width:40px; height:40px; cursor:grab; user-select:none; }
    .dropped-img { position:absolute; width:50px; height:50px; cursor:move; }

    #contextMenu{
      position:fixed; display:none; z-index:1000;
      background:#f9fafb; border:1px solid #d1d5db; border-radius:0.5rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      padding:0.25rem; min-width:160px;
    }
    #contextMenu button{
      display:block; width:100%; text-align:left;
      padding:0.35rem 0.5rem;
      font-size:0.875rem; border-radius:0.25rem;
    }
    #contextMenu button:hover{ background:#e5e7eb; }
    .menu-sep{ height:1px; background:#e5e7eb; margin:0.25rem 0; }
  </style>
</head>

<body class="p-4 md:p-6">
  <!-- Toolbar -->
  <div id="toolbar" class="max-w-screen-2xl mx-auto mb-4 flex flex-wrap gap-2 items-center">
    <div class="flex flex-wrap items-center gap-2">
      <label class="text-sm text-slate-700">Month</label>
      <select id="monthSel" class="border rounded px-2 py-1"></select>
      <label class="text-sm text-slate-700">Year</label>
      <select id="yearSel" class="border rounded px-2 py-1"></select>
      <button id="startFresh" class="ml-2 px-3 py-2 rounded font-semibold bg-gray-200 hover:bg-gray-300">Start Fresh</button>
    </div>

    <div class="flex flex-wrap items-center gap-2 ml-auto">
      <label class="text-sm text-slate-700">Theme</label>
      <select id="themeSel" class="border rounded px-2 py-1">
        <option value="none">None</option>
        <option value="spring">Spring</option>
        <option value="summer">Summer</option>
        <option value="fall">Fall</option>
        <option value="winter">Winter</option>
        <option value="holiday">Holiday</option>
      </select>
      <input type="file" id="bgUpload" accept="image/*" class="hidden">
      <button id="bgUploadBtn" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Upload Background</button>
      <label class="flex items-center gap-1 text-sm text-slate-700">
        <input type="checkbox" id="hiContrast">
        High Contrast (fade bg)
      </label>

      <button id="exportBtn" class="px-4 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">Export 11×17 PDF</button>
      <button id="clearBtn" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300">Clear Calendar</button>
    </div>
  </div>

  <!-- Layout -->
  <div class="flex gap-4 max-w-screen-2xl mx-auto">
    <!-- Sidebar -->
    <aside id="graphics-panel" class="w-1/5 bg-gray-50 p-3 rounded-lg border border-gray-300">
      <h2 class="text-lg font-bold mb-3 text-center">Graphics</h2>

      <div class="mb-2 text-xs font-semibold text-slate-600">Games</div>
      <div class="flex flex-wrap gap-2 mb-3">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616490.png" class="draggable-img" draggable="true" title="Bingo">
        <img src="https://cdn-icons-png.flaticon.com/512/3210/3210087.png" class="draggable-img" draggable="true" title="Cards">
        <img src="https://cdn-icons-png.flaticon.com/512/2553/2553691.png" class="draggable-img" draggable="true" title="Board Games">
      </div>

      <div class="mb-2 text-xs font-semibold text-slate-600">Music & Faith</div>
      <div class="flex flex-wrap gap-2 mb-3">
        <img src="https://cdn-icons-png.flaticon.com/512/3944/3944169.png" class="draggable-img" draggable="true" title="Music">
        <img src="https://cdn-icons-png.flaticon.com/512/3176/3176292.png" class="draggable-img" draggable="true" title="Church">
        <img src="https://cdn-icons-png.flaticon.com/512/1827/1827370.png" class="draggable-img" draggable="true" title="Rosary">
      </div>

      <div class="mb-2 text-xs font-semibold text-slate-600">Creative & Social</div>
      <div class="flex flex-wrap gap-2 mb-3">
        <img src="https://cdn-icons-png.flaticon.com/512/4359/4359863.png" class="draggable-img" draggable="true" title="Crafts">
        <img src="assetsicons/coffee.png" class="draggable-img" draggable="true" title="Coffee">
	<img src="assetsicons/bingo.png" class="draggable-img" draggable="true" title="Bingo">
        <img src="https://cdn-icons-png.flaticon.com/512/1744/1744065.png" class="draggable-img" draggable="true" title="Party">
      </div>

      <div class="mb-2 text-xs font-semibold text-slate-600">Fitness & Movies</div>
      <div class="flex flex-wrap gap-2">
        <img src="https://cdn-icons-png.flaticon.com/512/3039/3039358.png" class="draggable-img" draggable="true" title="Exercise">
        <img src="https://cdn-icons-png.flaticon.com/512/3670/3670151.png" class="draggable-img" draggable="true" title="Movie">
      </div>

      <p class="mt-3 text-xs text-center text-gray-600">Drag icons into a day. Right-click for options.</p>
    </aside>

    <!-- Calendar -->
    <div id="print-area" class="flex-1 p-4 border border-slate-300 rounded-xl">
      <img id="bgTheme" alt="Background Theme"/>

      <div class="mb-3 flex flex-col items-center relative z-10">
        <div class="text-2xl md:text-3xl font-bold text-center">
          <span id="facility" class="editable-header" contenteditable="true">Facility Name</span>
        </div>
        <div class="text-xl md:text-2xl font-semibold text-center text-slate-700">
          <span id="monthYear" class="editable-header" contenteditable="true">Month YYYY Activity Calendar</span>
        </div>
      </div>

      <div class="grid grid-cols-7 border border-gray-300 relative z-10">
        <div class="weekday">Sunday</div>
        <div class="weekday">Monday</div>
        <div class="weekday">Tuesday</div>
        <div class="weekday">Wednesday</div>
        <div class="weekday">Thursday</div>
        <div class="weekday">Friday</div>
        <div class="weekday">Saturday</div>
      </div>

      <div id="calendar" class="day-grid grid grid-cols-7 gap-1 border border-gray-300 relative z-10"></div>
    </div>
  </div>

  <div id="contextMenu"></div>

  <script>
    // ===== UTIL =====
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    function daysIn(m,y){ return new Date(y,m+1,0).getDate(); }
    function firstWeekday(m,y){ return new Date(y,m,1).getDay(); }

    const monthSel=document.getElementById('monthSel');
    const yearSel=document.getElementById('yearSel');
    const now=new Date();
    months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=m; monthSel.appendChild(o); });
    for(let y=now.getFullYear()-3;y<=now.getFullYear()+3;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; yearSel.appendChild(o); }
    monthSel.value=now.getMonth(); yearSel.value=now.getFullYear();

    const calendar=document.getElementById("calendar");
    const boxes=[];
    for(let i=0;i<42;i++){
      const box=document.createElement("div");
      box.className="day-box";
      box.innerHTML=`<div class="day-num"></div><div class="day-content" contenteditable="true"></div>`;
      calendar.appendChild(box);
      boxes.push(box);
    }

    function renumberGrid(){
      const m=parseInt(monthSel.value,10);
      const y=parseInt(yearSel.value,10);
      document.getElementById('monthYear').textContent=`${months[m]} ${y} Activity Calendar`;
      const start=firstWeekday(m,y);
      const total=daysIn(m,y);
      let d=1;
      for(let i=0;i<42;i++){
        const n=boxes[i].querySelector('.day-num');
        const active=i>=start&&i<start+total;
        boxes[i].classList.toggle('inactive',!active);
        n.textContent=active?d++:'';
      }
    }

    // ===== EXPORT TO PDF (final fixed version) =====
    document.getElementById("exportBtn").addEventListener("click", async ()=>{
      const { jsPDF }=window.jspdf;
      const node=document.getElementById("print-area");

      const canvas=await html2canvas(node,{scale:2,useCORS:true,backgroundColor:"#ffffff"});
      const imgData=canvas.toDataURL("image/png");
      const pdf=new jsPDF({orientation:"landscape",unit:"in",format:[17,11]});

      const pdfW=17, pdfH=11;
      const imgW=canvas.width/96, imgH=canvas.height/96;
      const imgRatio=imgW/imgH, pageRatio=pdfW/pdfH;

      let w,h,x,y;
      if(imgRatio>pageRatio){ w=pdfW; h=pdfW/imgRatio; x=0; y=(pdfH-h)/2; }
      else{ h=pdfH; w=pdfH*imgRatio; x=(pdfW-w)/2; y=0; }

      pdf.addImage(imgData,"PNG",x-0.05,y-0.05,w+0.1,h+0.1);
      const title=document.getElementById("monthYear").innerText.replace(/\s+/g,"_");
      pdf.save(`${title}.pdf`);
    });

    // ===== INIT =====
function resetForNewMonth() {
  // Ask before clearing everything
  if (!confirm("Start a new calendar for this month? This will clear all text, images, and box colors but keep your background and headers.")) {
    // Cancelled — revert to previous selection
    monthSel.value = prevMonth;
    yearSel.value = prevYear;
    return;
  }

  // Clear all text and icons
  document.querySelectorAll('.day-content').forEach(el => el.textContent = "");
  document.querySelectorAll('.dropped-img').forEach(el => el.remove());
  boxes.forEach(b => b.style.backgroundColor = "");

  // Update header and re-number the days
  renumberGrid();
  document.getElementById('monthYear').textContent =
    `${months[parseInt(monthSel.value,10)]} ${yearSel.value} Activity Calendar`;

  // Save current month/year as reference
  prevMonth = parseInt(monthSel.value,10);
  prevYear  = parseInt(yearSel.value,10);
}

let prevMonth = parseInt(monthSel.value,10);
let prevYear  = parseInt(yearSel.value,10);

// Hook month and year dropdowns to trigger reset
monthSel.addEventListener('change', resetForNewMonth);
yearSel.addEventListener('change', resetForNewMonth);
    
renumberGrid();
  </script>
</body>
</html>
