<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resident Feud — ProjectorFirst</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* ProjectorFirst Theme Colors */
  :root {
    --pf-dark-blue: #0b2a8a;
    --pf-mid-blue: #1e3a8a;
    --pf-yellow: #facc15;
    --pf-green: #16a34a;
    --pf-red: #dc2626;
    --pf-white: #ffffff;
  }
  body { background:var(--pf-dark-blue); color:var(--pf-white); font-family: Arial, sans-serif; }
  .card { background:var(--pf-white); color:var(--pf-dark-blue); border:6px solid var(--pf-mid-blue); border-radius:20px; }
  
  /* Game Board Elements */
  .answer-card { 
    cursor:pointer; 
    user-select:none; 
    transition: all 0.15s ease-in-out;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .answer-revealed { 
    background:#ecfdf5 !important; /* Light green background */
    border-color:var(--pf-green) !important; 
  }
  .answer-text { display: none; }
  .answer-revealed .answer-text { display: block; }

  /* Strike System */
  #strikes { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
  .strike-mark { 
    font-size: 5rem; 
    font-weight: 900; 
    color: var(--pf-red); 
    opacity: 0.3; 
    transition: opacity 0.3s;
  }
  .strike-mark.active { opacity: 1; }

  /* Big X overlay */
  .overlayX {
    position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
    background: rgba(220, 38, 38, 0.20); z-index: 50;
  }
  .overlayX .bigX {
    font-size: 22vw; line-height: 1; font-weight: 900; color:#ff0000;
    text-shadow: 0 0 40px rgba(0,0,0,0.6);
  }

  /* Drawer Editor */
  #drawer {
    position: fixed; top:0; right:-520px; width:520px; height:100vh; z-index:60;
    background:var(--pf-white); color:var(--pf-dark-blue); border-left:8px solid var(--pf-mid-blue);
    box-shadow: -10px 0 30px rgba(0,0,0,0.25); transition:right .25s ease;
    overflow:auto;
  }
  #drawer.open { right:0; }
  .big-btn { font-size:32px; padding:18px 28px; font-weight:800; border-radius:16px; }
  .team-toggle { outline: 4px solid transparent; transition: outline-color 0.1s; }
  .team-toggle.active { outline-color: var(--pf-yellow); }
</style>
</head>
<body>

<div class="flex flex-wrap items-center justify-between gap-4 p-6">
  <a href="apps.html" class="bg-blue-900 hover:bg-blue-800 px-6 py-3 rounded-xl text-white font-bold text-xl">← Apps</a>

    <div class="flex items-center gap-3">
    <span class="text-xl font-bold">Award points to:</span>
    <button id="team1Btn" class="team-toggle bg-white text-blue-900 font-extrabold text-2xl rounded-xl px-5 py-3">Table 1</button>
    <button id="team2Btn" class="team-toggle bg-white text-blue-900 font-extrabold text-2xl rounded-xl px-5 py-3">Table 2</button>
    <span class="text-sm opacity-80">(Leave none selected to reveal with no points.)</span>
  </div>

  <div class="flex items-center gap-3">
    <button id="openEditor" class="bg-purple-700 hover:bg-purple-600 px-6 py-3 rounded-xl text-white font-bold text-xl">Question Editor</button>
    <button id="nextQ" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-xl text-white font-bold text-xl">Next Question</button>
  </div>
</div>

<div class="max-w-6xl mx-auto px-6 mb-4">
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 items-start">
        <div class="card p-5 text-center">
      <div class="text-3xl font-extrabold text-blue-900">Total Score (Table 1)</div>
      <div id="score1" class="text-6xl font-black text-blue-900 mt-2">0</div>
    </div>

        <div class="flex flex-col items-center justify-start h-full">
      <div id="strikes">
        <div id="strike1" class="strike-mark">X</div>
        <div id="strike2" class="strike-mark">X</div>
        <div id="strike3" class="strike-mark">X</div>
      </div>
      <button id="strikeBtn" class="big-btn bg-red-600 hover:bg-red-500 text-white mt-4">❌ Strike</button>
      <div class="text-center mt-4 p-3 bg-yellow-400 text-blue-900 rounded-xl font-extrabold w-full">
        <div class="text-xl">Round Points</div>
        <div id="roundScore" class="text-4xl">0</div>
      </div>
    </div>

        <div class="card p-5 text-center">
      <div class="text-3xl font-extrabold text-blue-900">Total Score (Table 2)</div>
      <div id="score2" class="text-6xl font-black text-blue-900 mt-2">0</div>
    </div>
  </div>
</div>

<div class="max-w-6xl mx-auto px-6">
  <div id="questionBox" class="card p-8 text-center bg-yellow-400 !border-yellow-600">
    <div class="text-3xl sm:text-5xl font-extrabold text-blue-900">Press “Next Question”</div>
  </div>
</div>

<div class="max-w-6xl mx-auto px-6 mt-6">
  <div id="answersGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
</div>

<div id="overlayX" class="overlayX"><div class="bigX">X</div></div>

<div id="drawer">
  <div class="p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-3xl font-extrabold">Question Editor</h2>
      <button id="closeEditor" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-xl font-bold text-blue-900">Close</button>
    </div>

    <label class="font-bold">Question</label>
    <textarea id="qInput" class="w-full border-2 border-blue-900 rounded-xl p-3 mb-4" rows="2" placeholder="e.g., Name something you bring to a picnic."></textarea>

    <div class="flex items-center justify-between mb-2">
      <div class="font-bold">Answers (click “+ Add Answer” to add rows)</div>
      <button id="addAns" class="bg-blue-900 text-white px-4 py-2 rounded-xl font-bold">+ Add Answer</button>
    </div>

    <div id="ansList" class="space-y-3 mb-6"></div>

    <button id="saveQ" class="bg-green-600 hover:bg-green-500 text-white font-bold px-6 py-3 rounded-xl">Save Question</button>

        <div id="refreshReminder" 
         class="mt-4 p-3 bg-yellow-200 text-yellow-900 font-bold text-xl rounded-xl hidden">
      ✅ Questions Saved! Refresh the page to load new questions.
    </div>

    <hr class="my-6 border-blue-200">

    <h3 class="text-2xl font-extrabold mb-2">Saved Questions</h3>
    <div id="savedWrap" class="space-y-2"></div>
  </div>
</div>

<script>
/* ------------------ Audio (WebAudio tones) ------------------ */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq=880, dur=0.15, type='sine', vol=0.2) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, dur*1000);
}
function ding() { playTone(1200, 0.10, 'sine', 0.25); setTimeout(()=>playTone(1500,0.10,'sine',0.25), 110); }
function buzz() { playTone(200, 0.25, 'square', 0.3); setTimeout(()=>playTone(160, 0.25,'square',0.3), 260); }
function fanfare() {
  ding();
  setTimeout(() => playTone(1800, 0.2, 'triangle', 0.3), 250);
  setTimeout(() => playTone(2200, 0.2, 'triangle', 0.3), 500);
}


/* ------------------ State ------------------ */
let questions = JSON.parse(localStorage.getItem('feudQuestions') || '[]');
let lastIndex = -1;
let current = null; // Current question object
let revealedCount = 0;
let currentRoundScore = 0;
let strikes = 0;

const defaultIfEmpty = [
  {
    q: "Name something you bring to a picnic.",
    answers: [
      { text: "Food", points: 35 },
      { text: "Blanket", points: 20 },
      { text: "Drinks", points: 18 },
      { text: "Utensils/Napkins", points: 12 },
      { text: "Games", points: 8 },
      { text: "Sunscreen", points: 7 }
    ]
  },
  {
    q: "Name something people do first thing in the morning.",
    answers: [
      { text: "Brush Teeth", points: 30 },
      { text: "Use Bathroom", points: 20 },
      { text: "Make Coffee", points: 18 },
      { text: "Shower", points: 12 },
      { text: "Check Phone", points: 10 },
      { text: "Get Dressed", points: 10 }
    ]
  }
];
if (questions.length === 0) { questions = defaultIfEmpty; localStorage.setItem('feudQuestions', JSON.stringify(questions)); }

/* ------------------ UI refs ------------------ */
const answersGrid = document.getElementById('answersGrid');
const questionBox = document.getElementById('questionBox');
const score1El = document.getElementById('score1');
const score2El = document.getElementById('score2');
const roundScoreEl = document.getElementById('roundScore');
const overlayX = document.getElementById('overlayX');

const team1Btn = document.getElementById('team1Btn');
const team2Btn = document.getElementById('team2Btn');
const strikeMarks = [
  document.getElementById('strike1'),
  document.getElementById('strike2'),
  document.getElementById('strike3')
];


let activeTeam = null; // '1' or '2' or null
let totalScore1 = 0, totalScore2 = 0;

/* ------------------ Score & Strike Updates ------------------ */
function updateScores() {
  score1El.textContent = String(totalScore1);
  score2El.textContent = String(totalScore2);
  roundScoreEl.textContent = String(currentRoundScore);
}

function updateStrikes() {
  strikeMarks.forEach((el, i) => {
    el.classList.toggle('active', i < strikes);
  });
  if (strikes === 3) {
    // Optional: Add a UI cue for when 3 strikes are hit
    questionBox.innerHTML = `<div class="text-3xl sm:text-5xl font-extrabold text-red-700">3 STRIKES! Choose a team to award the ${currentRoundScore} points.</div>`;
    fanfare();
  }
}

/* ------------------ Team toggle ------------------ */
function setActiveTeam(t) {
  activeTeam = t;
  team1Btn.classList.toggle('active', t === '1');
  team2Btn.classList.toggle('active', t === '2');
}
team1Btn.addEventListener('click', ()=> setActiveTeam(activeTeam === '1' ? null : '1'));
team2Btn.addEventListener('click', ()=> setActiveTeam(activeTeam === '2' ? null : '2'));

/* ------------------ Render Question ------------------ */
function pickRandomIndex() {
  if (questions.length === 1) return 0;
  let i;
  do { i = Math.floor(Math.random() * questions.length); } while (i === lastIndex);
  lastIndex = i;
  return i;
}

function renderQuestion(qObj) {
  current = JSON.parse(JSON.stringify(qObj)); // clone for safety
  currentRoundScore = 0;
  revealedCount = 0;
  strikes = 0;
  updateScores();
  updateStrikes();
  setActiveTeam(null);
  overlayX.style.display = 'none';

  // question
  questionBox.innerHTML = `<div class="text-3xl sm:text-5xl font-extrabold">${escapeHtml(current.q)}</div>`;

  // answers
  answersGrid.innerHTML = '';
  current.answers
    .filter(a => a.text && !isNaN(+a.points))
    .sort((a, b) => b.points - a.points) // Sort answers by points (highest first)
    .slice(0, 8) // up to 8 slots
    .forEach((a, idx) => {
      const card = document.createElement('button');
      card.className = 'card answer-card p-4 sm:p-5 text-left';
      card.dataset.revealed = '0';
      card.dataset.points = String(+a.points);

      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="text-3xl sm:text-4xl font-black">${idx + 1}</div>
          <div class="answer-text text-3xl sm:text-4xl font-extrabold uppercase text-blue-900">${escapeHtml(a.text)}</div>
          <div class="text-3xl sm:text-4xl font-black text-green-700">+ ${+a.points}</div>
        </div>
        <div class="text-center mt-2 text-2xl font-extrabold text-blue-500 answer-placeholder">CLICK TO REVEAL</div>
      `;

      card.addEventListener('click', () => {
        if (card.dataset.revealed === '1') return;
        if (strikes >= 3 && activeTeam === null) { 
          alert("3 strikes! Choose a team to award the current round points before revealing more.");
          return;
        }

        // reveal
        card.dataset.revealed = '1';
        card.classList.add('answer-revealed');
        card.querySelector('.answer-placeholder').remove();
        revealedCount++;

        const pts = +card.dataset.points;
        currentRoundScore += pts;

        // award points if a team is active OR if all answers are revealed
        if (activeTeam === '1') { 
          totalScore1 += pts; 
        } else if (activeTeam === '2') { 
          totalScore2 += pts; 
        } 
        
        updateScores();
        ding();
        
        // Check for end of round
        if (revealedCount === current.answers.length) {
          questionBox.innerHTML = `<div class="text-3xl sm:text-5xl font-extrabold text-green-700">ROUND COMPLETE! Total points: ${currentRoundScore}</div>`;
          fanfare();
        }
      });

      answersGrid.appendChild(card);
    });
}

/* ------------------ Strike ------------------ */
document.getElementById('strikeBtn').addEventListener('click', () => {
  if (strikes < 3) {
    strikes++;
    updateStrikes();
    overlayX.style.display = 'flex';
    buzz();
    setTimeout(()=> overlayX.style.display = 'none', 1500); // Shorter duration for responsiveness
  } else {
    alert("Maximum strikes reached for this round!");
  }
});

/* ------------------ Next Question ------------------ */
document.getElementById('nextQ').addEventListener('click', () => {
  const idx = pickRandomIndex();
  renderQuestion(questions[idx]);
});

/* ------------------ Editor Drawer (Logic remains the same) ------------------ */
const drawer = document.getElementById('drawer');
document.getElementById('openEditor').addEventListener('click', () => {
  drawer.classList.add('open');
  rebuildSaved(); 
});
document.getElementById('closeEditor').addEventListener('click', () => drawer.classList.remove('open'));

const ansList = document.getElementById('ansList');
document.getElementById('addAns').addEventListener('click', addAnswerRow);

function addAnswerRow(textVal = '', pointsVal = '') {
  const row = document.createElement('div');
  row.className = 'grid grid-cols-12 gap-3 items-center';
  row.innerHTML = `
    <div class="col-span-7">
      <input class="w-full border-2 border-blue-900 rounded-xl p-2" placeholder="Answer text" value="${escapeAttr(textVal)}">
    </div>
    <div
